<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com Rea√ß√µes - WebSocket</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }

        .login-screen {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 40px;
        }

        .login-screen h1 {
            margin-bottom: 30px;
            color: #667eea;
        }

        .login-screen input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-screen button {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-screen button:hover {
            background: #5568d3;
        }

        .chat-container {
            width: 100%;
            display: none;
            flex-direction: row;
        }

        .chat-container.active {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #f7f7f7;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #667eea;
            color: white;
        }

        .sidebar-header h3 {
            margin-bottom: 5px;
        }

        .sidebar-header .username {
            font-size: 14px;
            opacity: 0.9;
        }

        .rooms-section {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .rooms-section h4 {
            margin-bottom: 10px;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .room-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .room-item:hover {
            background: #f0f0f0;
        }

        .room-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .room-item .room-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .room-item .room-users {
            font-size: 12px;
            opacity: 0.7;
        }

        .join-room-form {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .join-room-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .join-room-form button {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            color: #333;
        }

        .chat-header button {
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.system {
            text-align: center;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        .message.user .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .message.user .username {
            font-weight: 600;
            color: #667eea;
            margin-right: 8px;
        }

        .message.user .timestamp {
            font-size: 11px;
            color: #999;
        }

        .message.user .message-content {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message.user .message-text {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }

        /* REA√á√ïES */
        .reactions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            align-items: center;
        }

        .reaction-button {
            padding: 4px 8px;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            user-select: none;
        }

        .reaction-button:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .reaction-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .reaction-button .count {
            font-size: 11px;
            font-weight: 600;
        }

        .add-reaction-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px dashed #ccc;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .add-reaction-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        /* REACTION PICKER */
        .reaction-picker {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            gap: 4px;
            z-index: 1000;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-picker .emoji-option {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 20px;
            transition: all 0.2s;
        }

        .reaction-picker .emoji-option:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }

        .message-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .typing-indicator {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 13px;
            color: #666;
            font-style: italic;
            min-height: 20px;
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
            padding: 0 20px 20px 20px;
        }

        .message-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .message-input button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .message-input button:hover {
            background: #5568d3;
        }

        .users-panel {
            width: 250px;
            background: #f7f7f7;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
        }

        .users-panel h3 {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }

        .user-list-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .user-list-item .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* Tooltip para rea√ß√µes */
        .reaction-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1001;
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <h1>üí¨ Sala de conversa√ß√£o com Rea√ß√µes</h1>
        <input type="text" id="usernameInput" placeholder="Digite seu nome de usu√°rio" maxlength="50">
        <button onclick="connect()">Conectar</button>
    </div>

    <!-- CHAT CONTAINER -->
    <div class="chat-container" id="chatContainer">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Salas de Chat</h3>
                <div class="username" id="currentUsername"></div>
            </div>

            <div class="rooms-section" id="roomsList">
                <h4>As minhas Salas</h4>
                <div class="empty-state" id="noRoomsMessage">
                    <p>Voc√™ ainda n√£o entrou em nenhuma sala</p>
                </div>
            </div>

            <div class="join-room-form">
                <input type="text" id="roomNameInput" placeholder="Nome da sala">
                <button onclick="joinRoom()">Entrar na Sala</button>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area">
            <div class="empty-state" id="selectRoomMessage" style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <h3>Selecione ou crie uma sala</h3>
                <p>Entre numa sala para come√ßar a conversar</p>
            </div>

            <div id="activeChat" style="display: none; flex: 1; flex-direction: column;">
                <div class="chat-header">
                    <h2 id="currentRoomName"></h2>
                    <button onclick="leaveCurrentRoom()">Sair da Sala</button>
                </div>

                <div class="messages" id="messages"></div>

                <div class="typing-indicator" id="typingIndicator"></div>

                <div class="message-input-wrapper">
                    <input type="text" id="messageInput" placeholder="Digite sua mensagem..."
                           oninput="handleTyping()" onkeypress="handleKeyPress(event)"
                           style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                    <button onclick="sendMessage()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Enviar</button>
                </div>
            </div>
        </div>

        <!-- USERS PANEL -->
        <div class="users-panel" id="usersPanel" style="display: none;">
            <h3>Online (<span id="userCount">0</span>)</h3>
            <div id="usersList"></div>
        </div>
    </div>
</div>

<!-- REACTION PICKER -->
<div class="reaction-picker" id="reactionPicker">
    <div class="emoji-option" onclick="selectEmoji('üëç')">üëç</div>
    <div class="emoji-option" onclick="selectEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
    <div class="emoji-option" onclick="selectEmoji('üòÇ')">üòÇ</div>
    <div class="emoji-option" onclick="selectEmoji('üòÆ')">üòÆ</div>
    <div class="emoji-option" onclick="selectEmoji('üò¢')">üò¢</div>
    <div class="emoji-option" onclick="selectEmoji('üî•')">üî•</div>
</div>

<div class="reaction-tooltip" id="reactionTooltip"></div>

<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
<script>
    let socket = null;
    let currentUsername = '';
    let currentUserId = '';
    let currentRoom = null;
    let joinedRooms = new Map();
    let currentPickerMessageId = null;
    let messageReactions = new Map();
    let typingUsers = new Set();
    let typingTimeout = null;

    function connect() {
        const username = document.getElementById('usernameInput').value.trim();

        if (!username) {
            alert('Por favor, digite um nome de usu√°rio');
            return;
        }

        currentUsername = username;

        socket = io('http://localhost:3000', {
            auth: { userId: username }
        });

        socket.on('connect', () => {
            console.log('Conectado:', socket.id);
            currentUserId = socket.id;
            showChatContainer();
        });

        socket.on('disconnect', () => {
            console.log('Desconectado');
        });

        socket.on('room:user_joined', (data) => {
            joinedRooms.set(data.roomId, {
                name: data.roomId,
                users: data.users
            });

            updateRoomsList();

            if (currentRoom === data.roomId) {
                updateUsersList(data.users);
                addSystemMessage(`${data.user.username} entrou na sala`);
            }
        });

        socket.on('room:user_left', (data) => {
            const room = joinedRooms.get(data.roomId);
            if (room) {
                room.users = data.users;
                updateRoomsList();
            }

            if (currentRoom === data.roomId) {
                updateUsersList(data.users);
                addSystemMessage(`${data.user.username} saiu da sala`);
            }
        });

        socket.on('chat:message', (data) => {
            if (currentRoom === data.roomId) {
                messageReactions.set(data.messageId, data.reactions || {});
                addUserMessage(data.messageId, data.sender.username, data.message, data.timestamp);
            }
        });

        // NOVO: Atualiza√ß√£o de rea√ß√µes
        socket.on('message:reaction_updated', (data) => {
            if (currentRoom === data.roomId) {
                messageReactions.set(data.messageId, data.reactions);
                updateMessageReactions(data.messageId, data.reactions);
            }
        });

        // NOVO: Typing indicator
        socket.on('room:typing', (data) => {
            if (currentRoom === data.roomId) {
                handleRemoteTyping(data.username, data.isTyping);
            }
        });

        socket.on('validation:error', (data) => {
            alert('Erro de valida√ß√£o: ' + data.errors.map(e => e.message).join(', '));
        });

        socket.on('error', (data) => {
            alert('Erro: ' + data.message);
        });
    }

    function showChatContainer() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('chatContainer').classList.add('active');
        document.getElementById('currentUsername').textContent = currentUsername;
    }

    function joinRoom() {
        const roomName = document.getElementById('roomNameInput').value.trim();

        if (!roomName) {
            alert('Digite o nome da sala');
            return;
        }

        socket.emit('join:room', {
            roomId: roomName,
            username: currentUsername
        });

        document.getElementById('roomNameInput').value = '';
    }

    function leaveCurrentRoom() {
        if (!currentRoom) return;

        socket.emit('leave:room', {
            roomId: currentRoom
        });

        joinedRooms.delete(currentRoom);
        currentRoom = null;

        updateRoomsList();
        hideChat();
    }

    function switchToRoom(roomId) {
        currentRoom = roomId;
        typingUsers.clear(); // Limpar typing indicator
        updateTypingIndicator();

        document.getElementById('selectRoomMessage').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';
        document.getElementById('usersPanel').style.display = 'block';

        document.getElementById('currentRoomName').textContent = `# ${roomId}`;
        document.getElementById('messages').innerHTML = '';

        const room = joinedRooms.get(roomId);
        if (room) {
            updateUsersList(room.users);
        }

        updateRoomsList();
    }

    function hideChat() {
        document.getElementById('selectRoomMessage').style.display = 'flex';
        document.getElementById('activeChat').style.display = 'none';
        document.getElementById('usersPanel').style.display = 'none';
    }

    function updateRoomsList() {
        const container = document.getElementById('roomsList');
        const noRoomsMsg = document.getElementById('noRoomsMessage');

        if (joinedRooms.size === 0) {
            noRoomsMsg.style.display = 'block';
            container.querySelectorAll('.room-item').forEach(el => el.remove());
            return;
        }

        noRoomsMsg.style.display = 'none';
        container.querySelectorAll('.room-item').forEach(el => el.remove());

        joinedRooms.forEach((room, roomId) => {
            const roomEl = document.createElement('div');
            roomEl.className = 'room-item' + (currentRoom === roomId ? ' active' : '');
            roomEl.onclick = () => switchToRoom(roomId);
            roomEl.innerHTML = `
          <div class="room-name"># ${room.name}</div>
          <div class="room-users">${room.users.length} usu√°rio(s)</div>
        `;
            container.appendChild(roomEl);
        });
    }

    function updateUsersList(users) {
        const container = document.getElementById('usersList');
        const countEl = document.getElementById('userCount');

        countEl.textContent = users.length;
        container.innerHTML = '';

        users.forEach(user => {
            const userEl = document.createElement('div');
            userEl.className = 'user-list-item';
            userEl.innerHTML = `
          <div class="status-dot"></div>
          <div>${user.username}</div>
        `;
            container.appendChild(userEl);
        });
    }

    function generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !currentRoom) return;

        const messageId = generateMessageId();

        socket.emit('chat:message', {
            messageId: messageId,
            roomId: currentRoom,
            message: message,
            timestamp: new Date().toISOString()
        });

        // Parar typing indicator ao enviar
        if (typingTimeout) {
            clearTimeout(typingTimeout);
        }
        socket.emit('room:typing', {
            roomId: currentRoom,
            isTyping: false
        });

        input.value = '';
        input.focus();
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function handleTyping() {
        if (!currentRoom) return;

        socket.emit('room:typing', {
            roomId: currentRoom,
            isTyping: true
        });

        // Limpar timeout anterior
        if (typingTimeout) {
            clearTimeout(typingTimeout);
        }

        // Ap√≥s 2 segundos sem digitar, enviar que parou
        typingTimeout = setTimeout(() => {
            socket.emit('room:typing', {
                roomId: currentRoom,
                isTyping: false
            });
        }, 2000);
    }

    function handleRemoteTyping(username, isTyping) {
        if (isTyping) {
            typingUsers.add(username);
        } else {
            typingUsers.delete(username);
        }
        updateTypingIndicator();
    }

    function updateTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');

        if (typingUsers.size === 0) {
            indicator.textContent = '';
            return;
        }

        const users = Array.from(typingUsers);
        if (users.length === 1) {
            indicator.textContent = `${users[0]} est√° digitando...`;
        } else if (users.length === 2) {
            indicator.textContent = `${users[0]} e ${users[1]} est√£o digitando...`;
        } else {
            indicator.textContent = `${users.length} pessoas est√£o digitando...`;
        }
    }

    function addSystemMessage(text) {
        const messagesDiv = document.getElementById('messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'message system';
        messageEl.textContent = text;
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addUserMessage(messageId, username, text, timestamp) {
        const messagesDiv = document.getElementById('messages');
        const messageEl = document.createElement('div');
        messageEl.className = 'message user';
        messageEl.dataset.messageId = messageId;

        const time = new Date(timestamp).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageEl.innerHTML = `
        <div class="message-header">
          <span class="username">${username}</span>
          <span class="timestamp">${time}</span>
        </div>
        <div class="message-content">
          <div class="message-text">${text}</div>
        </div>
        <div class="reactions-container" id="reactions-${messageId}">
          <button class="add-reaction-btn" onclick="showReactionPicker(event, '${messageId}')">‚ûï</button>
        </div>
      `;

        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Renderizar rea√ß√µes se j√° existirem
        const reactions = messageReactions.get(messageId);
        if (reactions) {
            updateMessageReactions(messageId, reactions);
        }
    }

    function showReactionPicker(event, messageId) {
        event.stopPropagation();
        const picker = document.getElementById('reactionPicker');
        const rect = event.target.getBoundingClientRect();

        picker.style.top = (rect.top - 60) + 'px';
        picker.style.left = rect.left + 'px';
        picker.classList.add('active');

        currentPickerMessageId = messageId;

        // Fechar ao clicar fora
        setTimeout(() => {
            document.addEventListener('click', closeReactionPicker);
        }, 100);
    }

    function closeReactionPicker() {
        const picker = document.getElementById('reactionPicker');
        picker.classList.remove('active');
        currentPickerMessageId = null;
        document.removeEventListener('click', closeReactionPicker);
    }

    function selectEmoji(emoji) {
        if (!currentPickerMessageId || !currentRoom) return;

        socket.emit('message:reaction', {
            messageId: currentPickerMessageId,
            roomId: currentRoom,
            emoji: emoji
        });

        closeReactionPicker();
    }

    function updateMessageReactions(messageId, reactions) {
        const container = document.getElementById(`reactions-${messageId}`);
        if (!container) return;

        // Limpar rea√ß√µes antigas (manter bot√£o +)
        container.querySelectorAll('.reaction-button').forEach(btn => btn.remove());

        // Adicionar novas rea√ß√µes
        Object.entries(reactions).forEach(([emoji, users]) => {
            if (users.length > 0) {
                const hasUserReacted = users.some(u => u.userId === currentUserId);

                const btn = document.createElement('button');
                btn.className = 'reaction-button' + (hasUserReacted ? ' active' : '');
                btn.innerHTML = `
            <span>${emoji}</span>
            <span class="count">${users.length}</span>
          `;
                btn.onclick = () => toggleReaction(messageId, emoji);

                // Tooltip com nomes
                btn.onmouseenter = (e) => showReactionTooltip(e, users);
                btn.onmouseleave = hideReactionTooltip;

                container.insertBefore(btn, container.lastChild);
            }
        });
    }

    function toggleReaction(messageId, emoji) {
        if (!currentRoom) return;

        socket.emit('message:reaction', {
            messageId: messageId,
            roomId: currentRoom,
            emoji: emoji
        });
    }

    function showReactionTooltip(event, users) {
        const tooltip = document.getElementById('reactionTooltip');
        const names = users.map(u => u.username).join(', ');

        tooltip.textContent = names;
        tooltip.style.display = 'block';

        const rect = event.target.getBoundingClientRect();
        tooltip.style.top = (rect.top - 35) + 'px';
        tooltip.style.left = rect.left + 'px';
    }

    function hideReactionTooltip() {
        const tooltip = document.getElementById('reactionTooltip');
        tooltip.style.display = 'none';
    }

    // Fechar picker ao clicar ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeReactionPicker();
        }
    });
</script>
</body>
</html>